{% extends "JobFinder_app/base.html" %}
{% load message_tags %}
{% block title %}Messages â€“ LiteSpeedJobs{% endblock %}

{% block content %}
<style>
    .inbox-container {
        display: flex;
        height: 75vh;
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid var(--ls-border);
    }

    .conversation-list {
        width: 30%;
        overflow-y: auto;
        background-color: var(--ls-bg-card);
    }

    .conversation-item {
        padding: 12px 15px;
        border-bottom: 1px solid var(--ls-border);
        cursor: pointer;
        transition: background 0.2s ease;
    }
    .conversation-item:hover {
        background-color: rgba(0, 0, 0, 0.04);
    }
    body.dark-mode .conversation-item:hover {
        background-color: rgba(255, 255, 255, 0.06);
    }

    .conversation-item.active {
        background-color: rgba(77, 171, 247, 0.1);
    }

    .chat-window {
        width: 70%;
        display: flex;
        flex-direction: column;
        background-color: var(--ls-bg);
    }

    .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px;
    }

    .message-bubble {
        max-width: 75%;
        padding: 10px 14px;
        margin-bottom: 12px;
        border-radius: 12px;
    }
    .sent {
        background-color: var(--ls-primary);
        color: #000;
        margin-left: auto;
    }
    .received {
        background-color: var(--ls-bg-card);
        border: 1px solid var(--ls-border);
    }

    .chat-input {
        padding: 10px 12px;
        border-top: 1px solid var(--ls-border);
        background-color: var(--ls-bg-card);
    }

    .drop-zone {
        border: 1px dashed var(--ls-border);
        border-radius: 8px;
        padding: 8px;
        text-align: center;
        margin-top: 6px;
        font-size: 0.85rem;
    }
    .drop-zone.dragover {
        background-color: rgba(77, 171, 247, 0.1);
    }
</style>

<div class="container mt-4 inbox-container">

    <!-- LEFT: Conversation list -->
    <div class="conversation-list">
        {% for convo in conversations %}
            {% with other=convo|other_user:request.user %}
                {{ other.username }}
            {% endwith %}
                <a href="?c={{ convo.id }}" class="text-decoration-none text-reset">
                    <div class="conversation-item {% if active_conversation and active_conversation.id == convo.id %}active{% endif %}">
                        <strong>{{ other.username }}</strong><br>
                        <small class="text-muted">
                            {% with last=convo.messages.last %}
                                {% if last %}
                                    {{ last.body|default:"(attachment)"|truncatechars:40 }}
                                {% else %}
                                    No messages yet
                                {% endif %}
                            {% endwith %}
                        </small>
                    </div>
                </a>
            
        {% empty %}
            <div class="p-3 text-muted">No conversations yet.</div>
        {% endfor %}
    </div>

    <!-- RIGHT: Chat window -->
    <div class="chat-window">
        {% if active_conversation %}
            <div class="chat-messages" id="chatMessages">
                {% for msg in active_conversation.messages.all %}
                    <div class="message-bubble {% if msg.sender == request.user %}sent{% else %}received{% endif %}">
                        {% if msg.body %}
                            <div>{{ msg.body|urlize|linebreaks }}</div>
                        {% endif %}

                        {% if msg.attachment %}
                            {% if msg.attachment.url|lower|endswith:".mp4" or msg.attachment.url|lower|endswith:".webm" %}
                                <video src="{{ msg.attachment.url }}" controls style="max-width: 100%; margin-top: 5px;"></video>
                            {% else %}
                                <a href="{{ msg.attachment.url }}" target="_blank" class="d-block mt-2">
                                    ðŸ“Ž Download attachment
                                </a>
                            {% endif %}
                        {% endif %}

                        <small class="text-muted d-block mt-1" style="font-size: 0.75rem;">
                            {{ msg.sender.username }} â€¢ {{ msg.created_at|date:"M d, H:i" }}
                        </small>
                    </div>
                {% endfor %}
            </div>

            <form method="POST" enctype="multipart/form-data" class="chat-input" id="chatForm">
                {% csrf_token %}
                <div class="input-group">
                    <input type="text" name="message" class="form-control" placeholder="Type a message...">
                    <input type="file" name="attachment" id="attachmentInput" class="d-none">
                    <button type="button" class="btn btn-outline-secondary" id="attachBtn">ðŸ“Ž</button>
                    <button class="btn btn-primary">Send</button>
                </div>
                <div class="drop-zone mt-2" id="dropZone">
                    Drag & drop a file here, or click the ðŸ“Ž button to attach.
                </div>
            </form>
        {% else %}
            <div class="d-flex justify-content-center align-items-center h-100">
                <h5 class="text-muted">Select a conversation to start messaging.</h5>
            </div>
        {% endif %}
    </div>
</div>

<script>
// Auto-scroll to bottom
const chatMessages = document.getElementById("chatMessages");
if (chatMessages) {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Attach button
const attachBtn = document.getElementById("attachBtn");
const attachmentInput = document.getElementById("attachmentInput");
const dropZone = document.getElementById("dropZone");

if (attachBtn && attachmentInput) {
    attachBtn.addEventListener("click", () => attachmentInput.click());
}

// Drag & drop
if (dropZone && attachmentInput) {
    dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("dragover");
    });
    dropZone.addEventListener("dragleave", () => {
        dropZone.classList.remove("dragover");
    });
    dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("dragover");
        if (e.dataTransfer.files.length > 0) {
            attachmentInput.files = e.dataTransfer.files;
        }
    });
}
</script>
{% endblock %}
